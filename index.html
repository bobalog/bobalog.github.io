<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>bobalog ìƒì‚°ì„± ë³¸ë¶€ ğŸ§‹</title>

  <style>
    @font-face {
      font-family: 'Mabiyet';
      src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2207-01@1.0/MabinogiClassicR.woff2') format('woff2');
      font-weight: normal;
      font-display: swap;
    }

    :root{
      --main-pink:#ffafcc;
      --sub-pink:#ffc8dd;
      --bg:#fdf0f5;
      --text:#555;
      --card:#ffffff;
      --muted:#888;
      --shadow: rgba(255,175,204,0.18);
    }
    [data-theme="night"]{
      --bg:#17141a;
      --text:#e9e4ea;
      --card:#241f27;
      --muted:#b9b0bb;
      --shadow: rgba(0,0,0,0.35);
      --sub-pink:#5a3b4a;
    }

    body{
      background: var(--bg);
      font-family:'Mabiyet', sans-serif;
      margin:0;
      color: var(--text);
      display:flex;
      justify-content:center;
      padding:18px;
    }
    .container{ width:100%; max-width:720px; }
    .card{
      background: var(--card);
      border-radius: 22px;
      box-shadow: 0 10px 22px var(--shadow);
      padding: 16px;
      margin-bottom: 14px;
      border: 1px solid rgba(255,200,221,0.35);
    }

    h1{ margin:6px 0 0; color:#ff8fab; text-align:center; font-size:1.9em; }
    h2{
      margin:0 0 10px;
      color:#ff8fab;
      font-size:1.25em;
      border-bottom:2px solid var(--sub-pink);
      padding-bottom:6px;
    }

    .top-links{ display:flex; flex-wrap:wrap; gap:6px; justify-content:center; }
    .btn{
      padding:8px 12px;
      border-radius: 14px;
      border:none;
      cursor:pointer;
      font-weight:bold;
      font-family:'Mabiyet';
      font-size:14px;
      color:white;
      text-decoration:none;
      transition:0.15s;
      display:inline-flex;
      gap:6px;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); }
    .ai-btn{ background: var(--main-pink); }
    .stock-btn{ background: #cdb4db; }
    .ghost{ background: transparent; border:1px solid var(--sub-pink); color: var(--text); }
    .danger{ background:#ff5d73; }
    .ok{ background:#7ccf93; }
    .small{ font-size:13px; padding:6px 10px; border-radius:12px; }

    #clock{ color:#ff8fab; font-weight:bold; margin:8px 0 0; text-align:center; }

    /* Tabs */
    .tabs{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:10px;
    }
    .tab{
      background: rgba(255,200,221,0.22);
      color: var(--text);
      border:1px solid rgba(255,200,221,0.4);
    }
    .tab.active{
      background: var(--main-pink);
      color: white;
      border-color: transparent;
    }

    /* Inputs */
    input, textarea, select{
      width:100%;
      padding:12px;
      border:1px solid var(--sub-pink);
      border-radius: 12px;
      outline:none;
      box-sizing:border-box;
      font-family:'Mabiyet';
      font-size:16px;
      background: transparent;
      color: var(--text);
    }
    textarea{ min-height: 120px; resize: vertical; }

    .row{ display:flex; gap:8px; align-items:center; }
    .col{ flex:1; }

    /* Lists */
    ul{ list-style:none; padding:0; margin:0; }
    li.item{
      background: rgba(255,245,248,0.7);
      border:1px solid rgba(255,200,221,0.35);
      padding:12px;
      border-radius: 14px;
      margin:8px 0;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .left{ display:flex; flex-direction:column; gap:4px; }
    .meta{ font-size:13px; color: var(--muted); display:flex; gap:8px; flex-wrap:wrap; }
    .badge{
      display:inline-block;
      padding:3px 8px;
      border-radius: 999px;
      font-size: 12px;
      border:1px solid rgba(255,200,221,0.7);
      background: rgba(255,200,221,0.18);
    }
    .done .title{ text-decoration: line-through; opacity:0.55; }
    .actions{ display:flex; gap:6px; }
    .title{ font-weight:bold; }

    .split{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 720px){
      .split{ grid-template-columns: 1fr 1fr; }
    }

    .hint{ font-size:13px; color: var(--muted); margin-top:8px; }
    .quote{ font-size:0.85em; color: var(--muted); text-align:center; margin:8px 0 0; }
    .hr{
      border-top:1px dashed var(--sub-pink);
      margin:12px 0;
      opacity:0.8;
    }
  </style>
</head>
<body data-theme="day">
  <div class="container">

    <!-- Header -->
    <div class="card">
      <div class="top-links">
        <a class="btn ai-btn" href="https://chatgpt.com" target="_blank">GPT</a>
        <a class="btn ai-btn" href="https://gemini.google.com" target="_blank">Gemini</a>
        <a class="btn ai-btn" href="https://grok.com" target="_blank">Grok</a>
        <a class="btn stock-btn" href="https://finance.naver.com/item/main.naver?code=005930" target="_blank">ì‚¼ì„±ì „ì ğŸ“ˆ</a>
        <a class="btn stock-btn" href="https://finance.naver.com/sise/sise_index.naver?code=KOSPI" target="_blank">KOSPI ğŸ“Š</a>
      </div>

      <div class="hr"></div>
      <h1>ğŸ§‹ bobalog ë³¸ë¶€</h1>
      <p id="clock"></p>
      <p class="quote">"ì‹œì‘ì€ ê·¸ ì¼ì˜ ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„ì´ë‹¤." - í”Œë¼í†¤</p>

      <div class="tabs" id="tabs">
        <button class="btn tab active" data-view="dashboard">Dashboard</button>
        <button class="btn tab" data-view="tasks">Tasks</button>
        <button class="btn tab" data-view="calendar">Calendar</button>
        <button class="btn tab" data-view="notes">Notes</button>
        <button class="btn tab" data-view="settings">Settings</button>
      </div>
    </div>

    <!-- Dashboard -->
    <div class="card view" id="view-dashboard">
      <h2>ğŸ  Dashboard</h2>
      <div class="split">
        <div>
          <h3 style="margin:0 0 8px; color:#ff8fab;">âœ… ì˜¤ëŠ˜ í•  ì¼</h3>
          <div class="row" style="margin-bottom:8px;">
            <div class="col"><input id="dashTaskText" placeholder="ì˜ˆ: ê³¼ì œ 1p ì‘ì„±" /></div>
            <div style="width:120px;">
              <select id="dashTaskPrio">
                <option value="high">ìš°ì„ ìˆœìœ„: ë†’ìŒ</option>
                <option value="mid" selected>ìš°ì„ ìˆœìœ„: ì¤‘ê°„</option>
                <option value="low">ìš°ì„ ìˆœìœ„: ë‚®ìŒ</option>
              </select>
            </div>
            <button class="btn ai-btn" id="dashAddTask" style="min-width:84px;">ì¶”ê°€</button>
          </div>
          <ul id="dashTasks"></ul>
          <div class="hint">ğŸ‘‰ ì²´í¬/ì‚­ì œëŠ” ë²„íŠ¼ìœ¼ë¡œ! (í´ë¦­ ê¼¬ì„ ë°©ì§€)</div>
        </div>

        <div>
          <h3 style="margin:0 0 8px; color:#ff8fab;">ğŸ“… ì˜¤ëŠ˜ ì¼ì •</h3>
          <div class="row" style="margin-bottom:8px;">
            <div class="col"><input id="dashEventTitle" placeholder="ì˜ˆ: ê¸°ë§ ê³¼ì œ ì œì¶œ" /></div>
            <div style="width:140px;">
              <select id="dashEventType">
                <option value="deadline">ì œì¶œ</option>
                <option value="exam">ì‹œí—˜</option>
                <option value="meeting">íšŒì˜</option>
              </select>
            </div>
            <button class="btn stock-btn" id="dashAddEvent" style="min-width:84px;">ì¶”ê°€</button>
          </div>
          <ul id="dashEvents"></ul>

          <h3 style="margin:14px 0 8px; color:#ff8fab;">ğŸ” ì˜¤ëŠ˜ ë£¨í‹´</h3>
          <ul id="dashRoutines"></ul>
          <div class="row" style="margin-top:8px;">
            <input id="dashRoutineName" placeholder="ì˜ˆ: ì¼ë³¸ì–´ 20ë¶„" />
            <button class="btn ok" id="dashAddRoutine" style="min-width:84px;">ì¶”ê°€</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tasks -->
    <div class="card view" id="view-tasks" style="display:none;">
      <h2>ğŸ—‚ï¸ Tasks</h2>

      <div class="split">
        <div>
          <div class="row" style="margin-bottom:8px;">
            <div class="col"><input id="taskText" placeholder="í•  ì¼ ë‚´ìš©" /></div>
            <div style="width:140px;">
              <select id="taskProject">
                <option value="ê³µë¶€" selected>í”„ë¡œì íŠ¸: ê³µë¶€</option>
                <option value="í•™ìƒíšŒ">í”„ë¡œì íŠ¸: í•™ìƒíšŒ</option>
                <option value="í¸ì§‘">í”„ë¡œì íŠ¸: í¸ì§‘</option>
                <option value="ì–¸ì–´">í”„ë¡œì íŠ¸: ì–¸ì–´</option>
                <option value="ê¸°íƒ€">í”„ë¡œì íŠ¸: ê¸°íƒ€</option>
              </select>
            </div>
          </div>
          <div class="row" style="margin-bottom:8px;">
            <div class="col">
              <input id="taskDue" type="date" />
            </div>
            <div style="width:180px;">
              <select id="taskPriority">
                <option value="high">ìš°ì„ ìˆœìœ„: ë†’ìŒ</option>
                <option value="mid" selected>ìš°ì„ ìˆœìœ„: ì¤‘ê°„</option>
                <option value="low">ìš°ì„ ìˆœìœ„: ë‚®ìŒ</option>
              </select>
            </div>
            <button class="btn ai-btn" id="addTask" style="min-width:84px;">ì €ì¥</button>
          </div>

          <div class="hint">ğŸ“Œ íŒ: ë‚ ì§œë¥¼ ë„£ìœ¼ë©´ â€œì˜¤ëŠ˜/ì´ë²ˆì£¼â€ í•„í„°ê°€ ì‚´ì•„ë‚˜!</div>
        </div>

        <div>
          <div class="row" style="margin-bottom:8px;">
            <select id="filterRange">
              <option value="all" selected>ê¸°ê°„: ì „ì²´</option>
              <option value="today">ê¸°ê°„: ì˜¤ëŠ˜</option>
              <option value="week">ê¸°ê°„: ì´ë²ˆì£¼</option>
            </select>
            <select id="filterProject">
              <option value="all" selected>í”„ë¡œì íŠ¸: ì „ì²´</option>
              <option value="ê³µë¶€">ê³µë¶€</option>
              <option value="í•™ìƒíšŒ">í•™ìƒíšŒ</option>
              <option value="í¸ì§‘">í¸ì§‘</option>
              <option value="ì–¸ì–´">ì–¸ì–´</option>
              <option value="ê¸°íƒ€">ê¸°íƒ€</option>
            </select>
          </div>
          <div class="row" style="margin-bottom:8px;">
            <select id="filterPriority">
              <option value="all" selected>ìš°ì„ ìˆœìœ„: ì „ì²´</option>
              <option value="high">ë†’ìŒ</option>
              <option value="mid">ì¤‘ê°„</option>
              <option value="low">ë‚®ìŒ</option>
            </select>
            <select id="filterStatus">
              <option value="all" selected>ìƒíƒœ: ì „ì²´</option>
              <option value="open">ë¯¸ì™„ë£Œ</option>
              <option value="done">ì™„ë£Œ</option>
            </select>
          </div>
          <button class="btn ghost" id="resetFilters">í•„í„° ì´ˆê¸°í™”</button>
        </div>
      </div>

      <ul id="taskList"></ul>
    </div>

    <!-- Calendar -->
    <div class="card view" id="view-calendar" style="display:none;">
      <h2>ğŸ“… Calendar</h2>

      <div class="split">
        <div>
          <div class="row" style="margin-bottom:8px;">
            <input id="eventTitle" placeholder="ì˜ˆ: ë²”ì£„ì˜ˆë°©ì‹¤ë¬´ ê¸°ë§" />
          </div>
          <div class="row" style="margin-bottom:8px;">
            <input id="eventDate" type="date" />
            <select id="eventType">
              <option value="deadline" selected>ì œì¶œ</option>
              <option value="exam">ì‹œí—˜</option>
              <option value="meeting">íšŒì˜</option>
            </select>
          </div>
          <textarea id="eventMemo" placeholder="ë©”ëª¨(ì¥ì†Œ/ì¤€ë¹„ë¬¼/ë§í¬ ë“±)"></textarea>
          <button class="btn stock-btn" id="addEvent" style="width:100%; margin-top:8px;">ì¼ì • ì €ì¥</button>
        </div>

        <div>
          <div class="row" style="margin-bottom:8px;">
            <select id="eventFilterType">
              <option value="all" selected>ì¢…ë¥˜: ì „ì²´</option>
              <option value="deadline">ì œì¶œ</option>
              <option value="exam">ì‹œí—˜</option>
              <option value="meeting">íšŒì˜</option>
            </select>
            <select id="eventFilterRange">
              <option value="upcoming" selected>ê¸°ê°„: ë‹¤ê°€ì˜¤ëŠ” ì¼ì •</option>
              <option value="all">ê¸°ê°„: ì „ì²´</option>
            </select>
          </div>
          <ul id="eventList"></ul>
          <div class="hint">â° â€œë‹¤ê°€ì˜¤ëŠ” ì¼ì •â€ì€ ì˜¤ëŠ˜ ê¸°ì¤€ ë¯¸ë˜ ë‚ ì§œë§Œ ë³´ì—¬ì¤˜!</div>
        </div>
      </div>
    </div>

    <!-- Notes -->
    <div class="card view" id="view-notes" style="display:none;">
      <h2>ğŸ“ Notes (ì „êµ1ë“± ë…¸íŠ¸ í…œí”Œë¦¿)</h2>

      <div class="split">
        <div>
          <div class="row" style="margin-bottom:8px;">
            <input id="noteTitle" placeholder="ì œëª© (ì˜ˆ: ì •ë³´ë³´í˜¸ê°œë¡  12ì£¼ì°¨ ì •ë¦¬)" />
          </div>
          <div class="row" style="margin-bottom:8px;">
            <select id="noteTemplate">
              <option value="basic" selected>í…œí”Œë¦¿: ê¸°ë³¸ ì¸ë±ìŠ¤</option>
              <option value="exam">í…œí”Œë¦¿: ì‹œí—˜ ëŒ€ë¹„</option>
              <option value="language">í…œí”Œë¦¿: ì–¸ì–´ í•™ìŠµ</option>
              <option value="meeting">í…œí”Œë¦¿: íšŒì˜ë¡</option>
            </select>
            <button class="btn ghost" id="applyTemplate" style="min-width:120px;">í…œí”Œë¦¿ ì ìš©</button>
          </div>
          <textarea id="noteBody" placeholder="ë‚´ìš©"></textarea>
          <button class="btn ai-btn" id="saveNote" style="width:100%; margin-top:8px;">ê²Œì‹œê¸€ë¡œ ì €ì¥</button>
          <div class="hint">âœ… ì´ì œ ë©”ëª¨ê°€ â€œí•œ ê°œ ë®ì–´ì“°ê¸°â€ê°€ ì•„ë‹ˆë¼ â€œê¸€ ëª©ë¡â€ìœ¼ë¡œ ìŒ“ì—¬!</div>
        </div>

        <div>
          <div class="row" style="margin-bottom:8px;">
            <input id="noteSearch" placeholder="ê²€ìƒ‰ (ì œëª©/ë‚´ìš©)" />
            <button class="btn ghost" id="clearNoteEditor" style="min-width:120px;">ìƒˆ ê¸€</button>
          </div>
          <ul id="noteList"></ul>
        </div>
      </div>
    </div>

    <!-- Settings -->
    <div class="card view" id="view-settings" style="display:none;">
      <h2>âš™ï¸ Settings</h2>

      <div class="split">
        <div>
          <h3 style="margin:0 0 8px; color:#ff8fab;">ğŸ¯ ëª©í‘œ</h3>
          <input id="goalText" placeholder="ì˜ˆ: ì´ë²ˆ ì£¼ ê°•ì˜í¸ì§‘ 6ê°œ ì™„ë£Œ" />
          <button class="btn ok" id="saveGoal" style="width:100%; margin-top:8px;">ëª©í‘œ ì €ì¥</button>
          <p class="hint" id="goalPreview"></p>

          <h3 style="margin:14px 0 8px; color:#ff8fab;">ğŸ¨ í…Œë§ˆ</h3>
          <div class="row">
            <button class="btn tab active" id="themeDay">Day</button>
            <button class="btn tab" id="themeNight">Night</button>
          </div>
        </div>

        <div>
          <h3 style="margin:0 0 8px; color:#ff8fab;">ğŸ’¾ ë°ì´í„° ë°±ì—…</h3>
          <button class="btn ghost" id="exportData" style="width:100%;">ë‚´ë³´ë‚´ê¸°(JSON ë³µì‚¬)</button>
          <textarea id="importBox" placeholder="ì—¬ê¸°ì— JSON ë¶™ì—¬ë„£ê³  'ê°€ì ¸ì˜¤ê¸°' ëˆ„ë¥´ê¸°"></textarea>
          <div class="row" style="margin-top:8px;">
            <button class="btn ai-btn" id="importData" style="flex:1;">ê°€ì ¸ì˜¤ê¸°</button>
            <button class="btn danger" id="wipeAll" style="flex:1;">ì´ˆê¸°í™”</button>
          </div>
          <div class="hint">ğŸ“Œ ë°±ì—…ì€ â€œë¸Œë¼ìš°ì € ì €ì¥â€ì´ë¼ í˜¹ì‹œ ëª°ë¼ì„œ ê¼­ í•„ìš”í•´!</div>
        </div>
      </div>
    </div>

  </div>

  <script>
    /* ---------------------------
      Storage Keys + App State
    --------------------------- */
    const KEY = {
      tasks: 'bobalog_tasks_v1',
      events: 'bobalog_events_v1',
      routines: 'bobalog_routines_v1',
      notes: 'bobalog_notes_v1',
      goal: 'bobalog_goal_v1',
      theme: 'bobalog_theme_v1'
    };

    const state = {
      tasks: load(KEY.tasks, []),
      events: load(KEY.events, []),
      routines: load(KEY.routines, [
        { id: uid(), name:'ë¬¼ ë§ˆì‹œê¸°', doneDates: [] },
        { id: uid(), name:'ì¼ë³¸ì–´ 20ë¶„', doneDates: [] },
      ]),
      notes: load(KEY.notes, []),
      goal: load(KEY.goal, ''),
      theme: load(KEY.theme, 'day'),
      editingNoteId: null
    };

    function load(key, fallback){
      try{
        const v = JSON.parse(localStorage.getItem(key));
        return (v === null || v === undefined) ? fallback : v;
      }catch(e){
        return fallback;
      }
    }
    function save(key, value){
      localStorage.setItem(key, JSON.stringify(value));
    }
    function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    function startOfWeekISO(){
      const d = new Date();
      const day = d.getDay(); // 0 Sun
      const diff = (day === 0 ? -6 : 1 - day); // Mon as start
      d.setDate(d.getDate() + diff);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    function endOfWeekISO(){
      const d = new Date(startOfWeekISO());
      d.setDate(d.getDate() + 6);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    function isBetween(dateISO, aISO, bISO){
      if(!dateISO) return false;
      return dateISO >= aISO && dateISO <= bISO;
    }
    function fmtType(type){
      return type === 'deadline' ? 'ì œì¶œ' : type === 'exam' ? 'ì‹œí—˜' : 'íšŒì˜';
    }
    function fmtPrio(p){
      return p === 'high' ? 'ë†’ìŒ' : p === 'mid' ? 'ì¤‘ê°„' : 'ë‚®ìŒ';
    }

    /* ---------------------------
      Clock
    --------------------------- */
    function updateClock(){
      const now = new Date();
      document.getElementById('clock').innerText = now.toLocaleString('ko-KR');
    }
    setInterval(updateClock, 1000);
    updateClock();

    /* ---------------------------
      Tabs / Views
    --------------------------- */
    const tabs = document.getElementById('tabs');
    tabs.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-view]');
      if(!btn) return;
      const view = btn.dataset.view;

      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      btn.classList.add('active');

      document.querySelectorAll('.view').forEach(v=>v.style.display='none');
      document.getElementById(`view-${view}`).style.display='block';

      renderAll();
    });

    /* ---------------------------
      Dashboard - Quick add
    --------------------------- */
    document.getElementById('dashAddTask').onclick = ()=>{
      const text = document.getElementById('dashTaskText').value.trim();
      const prio = document.getElementById('dashTaskPrio').value;
      if(!text) return;
      state.tasks.unshift({
        id: uid(),
        text, project:'ê³µë¶€',
        due: todayISO(),
        priority: prio,
        done:false,
        createdAt: Date.now()
      });
      document.getElementById('dashTaskText').value = '';
      save(KEY.tasks, state.tasks);
      renderAll();
    };

    document.getElementById('dashAddEvent').onclick = ()=>{
      const title = document.getElementById('dashEventTitle').value.trim();
      const type = document.getElementById('dashEventType').value;
      if(!title) return;
      state.events.unshift({
        id: uid(),
        title, type,
        date: todayISO(),
        memo:'',
        createdAt: Date.now()
      });
      document.getElementById('dashEventTitle').value = '';
      save(KEY.events, state.events);
      renderAll();
    };

    document.getElementById('dashAddRoutine').onclick = ()=>{
      const name = document.getElementById('dashRoutineName').value.trim();
      if(!name) return;
      state.routines.unshift({ id: uid(), name, doneDates: [] });
      document.getElementById('dashRoutineName').value = '';
      save(KEY.routines, state.routines);
      renderAll();
    };

    /* ---------------------------
      Tasks - Add + Filters
    --------------------------- */
    document.getElementById('addTask').onclick = ()=>{
      const text = document.getElementById('taskText').value.trim();
      const project = document.getElementById('taskProject').value;
      const due = document.getElementById('taskDue').value || '';
      const priority = document.getElementById('taskPriority').value;
      if(!text) return;

      state.tasks.unshift({ id: uid(), text, project, due, priority, done:false, createdAt: Date.now() });
      document.getElementById('taskText').value = '';
      save(KEY.tasks, state.tasks);
      renderTasks();
      renderDashboard();
    };

    ['filterRange','filterProject','filterPriority','filterStatus'].forEach(id=>{
      document.getElementById(id).onchange = renderTasks;
    });

    document.getElementById('resetFilters').onclick = ()=>{
      document.getElementById('filterRange').value = 'all';
      document.getElementById('filterProject').value = 'all';
      document.getElementById('filterPriority').value = 'all';
      document.getElementById('filterStatus').value = 'all';
      renderTasks();
    };

    function filteredTasks(){
      const range = document.getElementById('filterRange').value;
      const project = document.getElementById('filterProject').value;
      const prio = document.getElementById('filterPriority').value;
      const status = document.getElementById('filterStatus').value;

      const t = todayISO();
      const a = startOfWeekISO();
      const b = endOfWeekISO();

      return state.tasks.filter(x=>{
        if(project !== 'all' && x.project !== project) return false;
        if(prio !== 'all' && x.priority !== prio) return false;
        if(status !== 'all'){
          if(status === 'open' && x.done) return false;
          if(status === 'done' && !x.done) return false;
        }
        if(range === 'today'){
          return x.due === t;
        }
        if(range === 'week'){
          return isBetween(x.due, a, b);
        }
        return true;
      });
    }

    /* ---------------------------
      Calendar - Add + Filters
    --------------------------- */
    document.getElementById('addEvent').onclick = ()=>{
      const title = document.getElementById('eventTitle').value.trim();
      const date = document.getElementById('eventDate').value;
      const type = document.getElementById('eventType').value;
      const memo = document.getElementById('eventMemo').value.trim();
      if(!title || !date) return;

      state.events.unshift({ id: uid(), title, date, type, memo, createdAt: Date.now() });
      document.getElementById('eventTitle').value = '';
      document.getElementById('eventDate').value = '';
      document.getElementById('eventMemo').value = '';
      save(KEY.events, state.events);
      renderCalendar();
      renderDashboard();
    };

    document.getElementById('eventFilterType').onchange = renderCalendar;
    document.getElementById('eventFilterRange').onchange = renderCalendar;

    function filteredEvents(){
      const type = document.getElementById('eventFilterType').value;
      const range = document.getElementById('eventFilterRange').value;
      const t = todayISO();

      return state.events
        .filter(e=>{
          if(type !== 'all' && e.type !== type) return false;
          if(range === 'upcoming' && e.date && e.date < t) return false;
          return true;
        })
        .sort((a,b)=> (a.date||'').localeCompare(b.date||''));
    }

    /* ---------------------------
      Notes - Post style ì €ì¥
    --------------------------- */
    const templates = {
      basic:
`# 1) í•µì‹¬ í‚¤ì›Œë“œ
- 

# 2) ê°œë… ì •ë¦¬(ì •ì˜)
- 

# 3) êµìˆ˜ë‹˜ ê°•ì¡° í¬ì¸íŠ¸
- 

# 4) ì˜ˆì‹œ/ì¼€ì´ìŠ¤
- 

# 5) í•œ ì¤„ ìš”ì•½
- `,
      exam:
`# ì •ë‹µ ë¨¼ì €
- 

# í•´ì„¤
- 

# ê·¼ê±°(í˜ì´ì§€/ìŠ¬ë¼ì´ë“œ)
- 

# ìì£¼ í‹€ë¦¬ëŠ” í¬ì¸íŠ¸
- `,
      language:
`# ë‹¨ì–´/í‘œí˜„
- 

# ë°œìŒ(í•œê¸€/ë¡œë§ˆì)
- 

# ì˜ˆë¬¸
- 

# ì˜¤ëŠ˜ì˜ ì•”ê¸° í¬ì¸íŠ¸
- `,
      meeting:
`# íšŒì˜ ì •ë³´
- ì¼ì‹œ:
- ì°¸ì„:
- ì•ˆê±´:

# ë…¼ì˜ ë‚´ìš©(ê²°ì •ì‚¬í•­/ì•¡ì…˜ì•„ì´í…œ)
- 

# ë‹¤ìŒ ì¼ì •
- `
    };

    document.getElementById('applyTemplate').onclick = ()=>{
      const t = document.getElementById('noteTemplate').value;
      document.getElementById('noteBody').value = templates[t] || '';
    };

    document.getElementById('saveNote').onclick = ()=>{
      const title = document.getElementById('noteTitle').value.trim();
      const body = document.getElementById('noteBody').value.trim();
      if(!title || !body) return;

      if(state.editingNoteId){
        const n = state.notes.find(x=>x.id === state.editingNoteId);
        if(n){
          n.title = title;
          n.body = body;
          n.updatedAt = Date.now();
        }
      }else{
        state.notes.unshift({ id: uid(), title, body, createdAt: Date.now(), updatedAt: null });
      }
      state.editingNoteId = null;
      document.getElementById('noteTitle').value = '';
      document.getElementById('noteBody').value = '';
      save(KEY.notes, state.notes);
      renderNotes();
    };

    document.getElementById('noteSearch').oninput = renderNotes;

    document.getElementById('clearNoteEditor').onclick = ()=>{
      state.editingNoteId = null;
      document.getElementById('noteTitle').value = '';
      document.getElementById('noteBody').value = '';
    };

    /* ---------------------------
      Settings - Goal / Theme / Backup
    --------------------------- */
    document.getElementById('saveGoal').onclick = ()=>{
      state.goal = document.getElementById('goalText').value.trim();
      save(KEY.goal, state.goal);
      renderSettings();
    };

    document.getElementById('themeDay').onclick = ()=> setTheme('day');
    document.getElementById('themeNight').onclick = ()=> setTheme('night');

    function setTheme(theme){
      state.theme = theme;
      document.body.setAttribute('data-theme', theme);
      save(KEY.theme, theme);

      document.getElementById('themeDay').classList.toggle('active', theme==='day');
      document.getElementById('themeNight').classList.toggle('active', theme==='night');
    }

    document.getElementById('exportData').onclick = async ()=>{
      const payload = {
        version: 1,
        exportedAt: new Date().toISOString(),
        data: {
          tasks: state.tasks,
          events: state.events,
          routines: state.routines,
          notes: state.notes,
          goal: state.goal,
          theme: state.theme
        }
      };
      const json = JSON.stringify(payload, null, 2);
      try{
        await navigator.clipboard.writeText(json);
        alert('ë°±ì—… JSONì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ëì–´! ğŸ€');
      }catch(e){
        document.getElementById('importBox').value = json;
        alert('í´ë¦½ë³´ë“œ ê¶Œí•œì´ ì—†ì–´ì„œ ì•„ë˜ ë°•ìŠ¤ì— ì¶œë ¥í–ˆì–´! ğŸ€');
      }
    };

    document.getElementById('importData').onclick = ()=>{
      const raw = document.getElementById('importBox').value.trim();
      if(!raw) return;
      try{
        const payload = JSON.parse(raw);
        const d = payload.data || payload;

        state.tasks = d.tasks || [];
        state.events = d.events || [];
        state.routines = d.routines || [];
        state.notes = d.notes || [];
        state.goal = d.goal || '';
        state.theme = d.theme || 'day';

        save(KEY.tasks, state.tasks);
        save(KEY.events, state.events);
        save(KEY.routines, state.routines);
        save(KEY.notes, state.notes);
        save(KEY.goal, state.goal);
        save(KEY.theme, state.theme);

        setTheme(state.theme);
        document.getElementById('importBox').value = '';
        renderAll();
        alert('ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ! ğŸ§‹');
      }catch(e){
        alert('JSON í˜•ì‹ì´ ì´ìƒí•´! ğŸ˜µâ€ğŸ’«');
      }
    };

    document.getElementById('wipeAll').onclick = ()=>{
      if(!confirm('ì§„ì§œ ì´ˆê¸°í™”í• ê¹Œ? (ë˜ëŒë¦¬ê¸° ì–´ë ¤ì›Œ)')) return;
      Object.values(KEY).forEach(k=>localStorage.removeItem(k));
      location.reload();
    };

    /* ---------------------------
      Render Helpers
    --------------------------- */
    function taskItemHTML(t){
      return `
        <li class="item ${t.done ? 'done':''}" data-id="${t.id}">
          <div class="left">
            <div class="title">${escapeHtml(t.text)}</div>
            <div class="meta">
              <span class="badge">í”„ë¡œì íŠ¸: ${escapeHtml(t.project)}</span>
              <span class="badge">ìš°ì„ ìˆœìœ„: ${fmtPrio(t.priority)}</span>
              ${t.due ? `<span class="badge">ê¸°í•œ: ${t.due}</span>` : `<span class="badge">ê¸°í•œ: ì—†ìŒ</span>`}
            </div>
          </div>
          <div class="actions">
            <button class="btn small ok js-toggle">ì™„ë£Œ</button>
            <button class="btn small danger js-del">ì‚­ì œ</button>
          </div>
        </li>
      `;
    }

    function eventItemHTML(ev){
      const memo = ev.memo ? ` Â· ${escapeHtml(ev.memo)}` : '';
      return `
        <li class="item" data-id="${ev.id}">
          <div class="left">
            <div class="title">${escapeHtml(ev.title)}</div>
            <div class="meta">
              <span class="badge">${ev.date || ''}</span>
              <span class="badge">${fmtType(ev.type)}</span>
              <span class="badge">ë©”ëª¨ ${ev.memo ? 'ìˆìŒ' : 'ì—†ìŒ'}</span>
            </div>
            ${ev.memo ? `<div class="hint">${escapeHtml(ev.memo)}</div>` : ''}
          </div>
          <div class="actions">
            <button class="btn small danger js-del">ì‚­ì œ</button>
          </div>
        </li>
      `;
    }

    function routineItemHTML(r){
      const t = todayISO();
      const done = r.doneDates.includes(t);
      return `
        <li class="item ${done ? 'done':''}" data-id="${r.id}">
          <div class="left">
            <div class="title">${escapeHtml(r.name)}</div>
            <div class="meta">
              <span class="badge">ì˜¤ëŠ˜: ${done ? 'ì™„ë£Œ' : 'ë¯¸ì™„ë£Œ'}</span>
              <span class="badge">ëˆ„ì : ${r.doneDates.length}ì¼</span>
            </div>
          </div>
          <div class="actions">
            <button class="btn small ok js-toggle">ì²´í¬</button>
            <button class="btn small danger js-del">ì‚­ì œ</button>
          </div>
        </li>
      `;
    }

    function noteItemHTML(n){
      const created = new Date(n.createdAt).toLocaleString('ko-KR');
      return `
        <li class="item" data-id="${n.id}">
          <div class="left">
            <div class="title">${escapeHtml(n.title)}</div>
            <div class="meta">
              <span class="badge">ì‘ì„±: ${created}</span>
              <span class="badge">${n.updatedAt ? 'ìˆ˜ì •ë¨' : 'ì›ë³¸'}</span>
            </div>
          </div>
          <div class="actions">
            <button class="btn small ghost js-open">ì—´ê¸°</button>
            <button class="btn small danger js-del">ì‚­ì œ</button>
          </div>
        </li>
      `;
    }

    function escapeHtml(s){
      return (s||'')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    /* ---------------------------
      Render: Dashboard
    --------------------------- */
    function renderDashboard(){
      const t = todayISO();

      // Today tasks
      const todayTasks = state.tasks.filter(x => x.due === t).slice(0, 6);
      const dashTasks = document.getElementById('dashTasks');
      dashTasks.innerHTML = todayTasks.length
        ? todayTasks.map(taskItemHTML).join('')
        : `<li class="item"><div class="left"><div class="title">ì˜¤ëŠ˜ í•  ì¼ì´ ë¹„ì–´ìˆì–´! ğŸ€</div><div class="hint">ìœ„ì—ì„œ í•˜ë‚˜ ì¶”ê°€í•´ë³´ì</div></div></li>`;

      // Today events
      const todayEvents = state.events.filter(e => e.date === t).slice(0, 6);
      const dashEvents = document.getElementById('dashEvents');
      dashEvents.innerHTML = todayEvents.length
        ? todayEvents.map(eventItemHTML).join('')
        : `<li class="item"><div class="left"><div class="title">ì˜¤ëŠ˜ ì¼ì • ì—†ìŒ</div><div class="hint">ì œì¶œ/ì‹œí—˜/íšŒì˜ë¥¼ ì¶”ê°€í•´ë‘ë©´ ë§ˆìŒì´ í¸í•´ì ¸ ğŸ˜</div></div></li>`;

      // Routines
      const dashRoutines = document.getElementById('dashRoutines');
      dashRoutines.innerHTML = state.routines.length
        ? state.routines.map(routineItemHTML).join('')
        : `<li class="item"><div class="left"><div class="title">ë£¨í‹´ì´ ë¹„ì–´ìˆì–´!</div></div></li>`;

      // bind actions in dashboard
      bindListActions(dashTasks, 'task');
      bindListActions(dashEvents, 'event');
      bindListActions(dashRoutines, 'routine');
    }

    /* ---------------------------
      Render: Tasks
    --------------------------- */
    function renderTasks(){
      const list = document.getElementById('taskList');
      const items = filteredTasks();
      list.innerHTML = items.length
        ? items.map(taskItemHTML).join('')
        : `<li class="item"><div class="left"><div class="title">ì¡°ê±´ì— ë§ëŠ” í•  ì¼ì´ ì—†ì–´ ğŸ˜º</div><div class="hint">í•„í„°ë¥¼ í’€ê±°ë‚˜ ìƒˆ í•  ì¼ì„ ì¶”ê°€í•´ë´!</div></div></li>`;

      bindListActions(list, 'task');
    }

    /* ---------------------------
      Render: Calendar
    --------------------------- */
    function renderCalendar(){
      const list = document.getElementById('eventList');
      const items = filteredEvents();
      list.innerHTML = items.length
        ? items.map(eventItemHTML).join('')
        : `<li class="item"><div class="left"><div class="title">ì¼ì •ì´ ë¹„ì–´ìˆì–´!</div><div class="hint">ì‹œí—˜/ì œì¶œ/íšŒì˜ë¥¼ ë¨¼ì € ë°•ì•„ë‘ì ğŸ§‹</div></div></li>`;

      bindListActions(list, 'event');
    }

    /* ---------------------------
      Render: Notes
    --------------------------- */
    function renderNotes(){
      const q = document.getElementById('noteSearch').value.trim().toLowerCase();
      const list = document.getElementById('noteList');

      const items = state.notes.filter(n=>{
        if(!q) return true;
        return (n.title||'').toLowerCase().includes(q) || (n.body||'').toLowerCase().includes(q);
      });

      list.innerHTML = items.length
        ? items.map(noteItemHTML).join('')
        : `<li class="item"><div class="left"><div class="title">ë…¸íŠ¸ê°€ ì•„ì§ ì—†ì–´!</div><div class="hint">ì™¼ìª½ì—ì„œ í…œí”Œë¦¿ ì ìš©í•˜ê³  ì €ì¥í•´ë³´ì ğŸ€</div></div></li>`;

      list.onclick = (e)=>{
        const li = e.target.closest('li.item');
        if(!li) return;
        const id = li.dataset.id;
        const n = state.notes.find(x=>x.id === id);
        if(!n) return;

        if(e.target.classList.contains('js-open')){
          state.editingNoteId = id;
          document.getElementById('noteTitle').value = n.title;
          document.getElementById('noteBody').value = n.body;
          return;
        }
        if(e.target.classList.contains('js-del')){
          state.notes = state.notes.filter(x=>x.id !== id);
          save(KEY.notes, state.notes);
          renderNotes();
          return;
        }
      };
    }

    /* ---------------------------
      Render: Settings
    --------------------------- */
    function renderSettings(){
      document.getElementById('goalText').value = state.goal || '';
      document.getElementById('goalPreview').innerText = state.goal ? `í˜„ì¬ ëª©í‘œ: ${state.goal}` : 'í˜„ì¬ ëª©í‘œê°€ ë¹„ì–´ìˆì–´!';
      setTheme(state.theme);
    }

    /* ---------------------------
      Bind actions for lists
      - ì—¬ê¸°ì„œ â€œSPAN í´ë¦­ ê¼¬ì„â€ì„ ì™„ì „íˆ í•´ê²°!
    --------------------------- */
    function bindListActions(container, kind){
      container.onclick = (e)=>{
        const li = e.target.closest('li.item');
        if(!li) return;
        const id = li.dataset.id;

        if(kind === 'task'){
          const t = state.tasks.find(x=>x.id === id);
          if(!t) return;

          if(e.target.classList.contains('js-toggle')){
            t.done = !t.done;
            save(KEY.tasks, state.tasks);
            renderAll();
            return;
          }
          if(e.target.classList.contains('js-del')){
            state.tasks = state.tasks.filter(x=>x.id !== id);
            save(KEY.tasks, state.tasks);
            renderAll();
            return;
          }
        }

        if(kind === 'event'){
          if(e.target.classList.contains('js-del')){
            state.events = state.events.filter(x=>x.id !== id);
            save(KEY.events, state.events);
            renderAll();
            return;
          }
        }

        if(kind === 'routine'){
          const r = state.routines.find(x=>x.id === id);
          if(!r) return;

          if(e.target.classList.contains('js-toggle')){
            const t = todayISO();
            const idx = r.doneDates.indexOf(t);
            if(idx >= 0) r.doneDates.splice(idx,1);
            else r.doneDates.push(t);

            save(KEY.routines, state.routines);
            renderAll();
            return;
          }
          if(e.target.classList.contains('js-del')){
            state.routines = state.routines.filter(x=>x.id !== id);
            save(KEY.routines, state.routines);
            renderAll();
            return;
          }
        }
      };
    }

    function renderAll(){
      renderDashboard();
      renderTasks();
      renderCalendar();
      renderNotes();
      renderSettings();
    }

    /* ---------------------------
      Init
    --------------------------- */
    // theme init
    document.body.setAttribute('data-theme', state.theme);
    renderAll();
  </script>
</body>
</html>
